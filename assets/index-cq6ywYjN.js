import*as o from"https://unpkg.com/three@0.126.1/build/three.module.js";import{OrbitControls as E}from"https://unpkg.com/three@0.126.1/examples/jsm/controls/OrbitControls.js";import{BVHLoader as G}from"https://unpkg.com/three@0.126.1/examples/jsm/loaders/BVHLoader.js";import{FBXLoader as H}from"https://unpkg.com/three@0.126.1/examples/jsm/loaders/FBXLoader.js";(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))p(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&p(f)}).observe(document,{childList:!0,subtree:!0});function y(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function p(n){if(n.ep)return;n.ep=!0;const r=y(n);fetch(n.href,r)}})();var S=new o.Clock,m,x,L;document.addEventListener("DOMContentLoaded",()=>{const c=new o.Scene,d=new o.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e4);d.position.set(0,0,400),d.lookAt(0,0,0);const y=new o.AmbientLight(16777215,.8);c.add(y);const p=new o.DirectionalLight(16777215,1);p.position.set(0,50,0),c.add(p);const n=new o.WebGLRenderer({antialias:!0});n.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(n.domElement),n.domElement,L=new o.Raycaster,x=new o.Vector2;const r=new E(d,n.domElement);r.enableDamping=!0,r.dampingFactor=.25,r.screenSpacePanning=!1,r.maxPolarAngle=Math.PI/2;const f=50,h=new Uint8Array(f*f*3);for(let e=0;e<f;e++)for(let t=0;t<f;t++){const s=(e*f+t)*3,i=(Math.floor(e/1)+Math.floor(t/1))%2===0?128:96;h[s]=i,h[s+1]=i,h[s+2]=i}const v=new o.DataTexture(h,f,f,o.RGBFormat);v.needsUpdate=!0;const k=new o.PlaneGeometry(5e3,5e3,1,1),z=new o.MeshBasicMaterial({map:v,side:o.DoubleSide}),C=new o.Mesh(k,z);C.rotation.x=-Math.PI/2,c.add(C);const O=new o.CubeTextureLoader().load(["textures/rt.bmp","textures/lt.bmp","textures/tp.bmp","textures/bt.bmp","textures/ft.bmp","textures/bk.bmp"]);c.background=O;const u=[];let g=null;new G().load("assets/gt.bvh",function(e){const t=new o.SkeletonHelper(e.skeleton.bones[0]);t.skeleton=e.skeleton,e.skeleton.bones[0];var s=new o.Group;s.add(e.skeleton.bones[0]),c.add(t),c.add(s),m=new o.AnimationMixer(t),m.clipAction(e.clip).play(),u.push(m),g&&P(e.skeleton,g)}),new H().load("assets/lafan1_tpose_small.fbx",e=>{if(e.mixer=new o.AnimationMixer(e),u.push(e.mixer),g=e,e.traverse(t=>{t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),c.add(e),u.length>0){const t=u[0];P(t.getRoot(),g)}});function P(e,t){e.bones,t.children[1].skeleton.bones.find(l=>l.name===e.bones[0].name)}let w=null,b=null;function A(e){x.x=e.clientX/window.innerWidth*2-1,x.y=-(e.clientY/window.innerHeight)*2+1,L.setFromCamera(x,d);const t=L.intersectObjects(c.children,!0);if(t.length>0){const s=t[0].point;w&&(c.remove(w),c.remove(b)),console.log("Intersected object:",t[0].object),console.log("Intersected point:",s),console.log("Intersected point num:",t.length);const l=new o.CylinderGeometry(1,1,180,32),i=new o.MeshBasicMaterial({color:16776960});w=new o.Mesh(l,i),s.y=90,w.position.copy(s),c.add(w);const a=new o.BoxGeometry(70,50,.1),M=new o.MeshBasicMaterial({color:16776960});b=new o.Mesh(a,M),s.x+=35,s.y=155,b.position.copy(s),c.add(b)}}window.addEventListener("resize",()=>{d.aspect=window.innerWidth/window.innerHeight,d.updateProjectionMatrix(),n.setSize(window.innerWidth,window.innerHeight)}),window.addEventListener("click",A,!1);function B(){requestAnimationFrame(B);var e=S.getDelta();m&&m.update(e);const t=m.getRoot().bones,s=u[1]._root.children[1].skeleton.bones;console.log(t[0].position),console.log(s[0].position);for(let l=0;l<t.length;l++){const i=t[l],a=s.find(M=>M.name===i.name);console.log(l,i,a),a&&(l==0?(a.position.x=i.position.x,a.position.y=-i.position.z,a.position.z=i.position.y,a.rotation.x=i.rotation.x+Math.PI/2,a.rotation.y=i.rotation.y,a.rotation.z=i.rotation.z):(console.log(l,i.name,a.name,a.rotation,i.rotation),a.rotation.x=i.rotation.x,a.rotation.y=i.rotation.y,a.rotation.z=i.rotation.z+Math.PI))}r.update(),n.render(c,d)}B()});
